<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Receipt</title>
    <link rel="stylesheet" th:href="@{/css/general_styles.css}">
    <link rel="stylesheet" th:href="@{/css/receiptpage_styles.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<header>
    <h1 class="webapp-title">Virtual Vending Machine Webapp</h1>
</header>

<!-- Display Logged-In User -->
<div class="user-info">
    <p>Logged In As: <span th:text="${username}">Guest</span></p>
</div>

<h2 class="receipt-heading">Transaction Receipt</h2>

<!-- Show error message if transaction is missing -->
<p th:if="${error}" class="error-text">
    Error: <span th:text="${error}"></span>
</p>

<button onclick="goBack()" class="back-button">⬅ Go Back</button>


<!-- Receipt Box Shown if No Errors -->
<div class="receipt-box" id="receiptBox" th:if="${transaction}">
    <p><strong>VIRTUAL VENDING MACHINE WEBAPP</strong></p>
    <p><strong>User:</strong> <span th:text="${#strings.isEmpty(transaction.user) ? 'Guest' : transaction.user}"></span></p>
    <p><strong>Transaction ID:</strong> <span th:text="${transaction.id}"></span></p>
    <p><strong>Date:</strong> <span th:text="${#dates.format(transaction.transactionDate, 'dd/MM/yyyy')}"></span></p>
    <p><strong>Time:</strong> <span th:text="${#dates.format(transaction.transactionDate, 'HH:mm:ss')}"></span></p>

    <div class="receipt-divider">----------------------------------------</div>

    <h3>Purchased Products:</h3>
    <ul>
        <li th:each="transactionProduct : ${transaction.transactionProducts}">
        <span th:text="${transactionProduct.quantity} + ' x ' + ${productNames[transactionProduct.productId]} +
               ' (£' + ${#numbers.formatDecimal(productPrices[transactionProduct.productId], 1, 2)} + ' each) - £' +
               ${#numbers.formatDecimal(transactionProduct.quantity * productPrices[transactionProduct.productId], 1, 2)}">
        </span>
        </li>
    </ul>


    <div class="receipt-divider">----------------------------------------</div>

    <p><strong>Total Cost:</strong> £<span th:text="${#numbers.formatDecimal(transaction.totalCost, 1, 2)}"></span></p>
    <p><strong>VAT: £0.00</strong></p>
    <p><strong>Payment(Cash):</strong> £<span th:text="${#numbers.formatDecimal(transaction.paymentReceived, 1, 2)}"></span></p>
    <p><strong>Change:</strong> £<span th:text="${#numbers.formatDecimal(transaction.changeGiven, 1, 2)}"></span></p>
</div>

<!-- Receipt Buttons -->
<div class="receipt-buttons">
    <button class="home-btn" onclick="exitToHome()">Return to Home</button>
    <button class="download-btn" onclick="downloadReceipt()"> Download Receipt
        <span class="download-icon">⬇</span>
    </button>
</div>

<script th:src="@{/scripts/payment_script.js}"></script>
</body>
</html>
